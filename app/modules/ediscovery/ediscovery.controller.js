(function () {
  'use strict';

  /* @ngInject */
  function EdiscoveryController($timeout, $window, $scope, $state, $translate, $modal, EdiscoveryService) {
    $scope.$on('$viewContentLoaded', function () {
      //setSearchFieldFocus();
      $window.document.title = $translate.instant("ediscovery.browserTabHeaderTitle");
    });
    var vm = this;

    vm.createReport = createReport;
    vm.deleteReports = deleteReports;
    vm.showSearchHelp = showSearchHelp;
    $scope.downloadable = downloadable;
    $scope.downloadReport = downloadReport;
    $scope.cancable = cancable;
    $scope.cancelReport = cancelReport;
    $scope.deletable = deletable;
    $scope.deleteReport = deleteReport;

    vm.searchCriteria = {
      "searchString": "36de9c50-8410-11e5-8b9b-9d7d6ad1ac82",
      "startDate": moment(),
      "endDate": moment(moment()).add(1, 'days')
    };
    vm.reports = [];

    var avalonPoller = $timeout(pollAvalonReport, 0);

    pollAvalonReport();

    function getStartDate() {
      return vm.searchCriteria.startDate;
    }

    function getEndDate() {
      return vm.searchCriteria.endDate;
    }

    function setEndDate(endDate) {
      vm.searchCriteria.endDate = endDate;
    }

    function dateErrors(start, end) {
      var errors = [];
      if (moment(start).isAfter(moment(end))) {
        errors.push("Start date must be before end date");
      }
      if (moment(start).isAfter(moment())) {
        errors.push("Start date cannot be in the future");
      }
      return errors;
    }

    function openGenericModal(title, messages) {
      $modal.open({
        templateUrl: "modules/ediscovery/genericModal.html",
        controller: 'EdiscoveryGenericModalCtrl as modal',
        resolve: {
          title: function () {
            return title;
          },
          messages: function () {
            return messages;
          }
        }
      });
    }

    function validateDate() {
      var title = "Date validation";
      var errors = dateErrors(getStartDate(), getEndDate());
      if (errors.length > 0) {
        openGenericModal(title, errors);
        return false;
      } else {
        return true;
      }
    }

    $scope.$watch(getStartDate, function (startDate) {
      //validateDate();
    });

    $scope.$watch(getEndDate, function (endDate) {
      //validateDate();
    });

    function downloadReport(id) {
      openGenericModal("Note", "Function not implemented");
    }

    function cancelReport(id) {
      EdiscoveryService.patchReport(id, {
        state: "ABORTED"
      }).then(function (res) {
        pollAvalonReport();
      });
    }

    function deleteReport(id) {
      EdiscoveryService.deleteReport(id).then(function (res) {
        pollAvalonReport();
      });
    }

    function cancable(id) {
      var r = findReportById(id);
      return r && r.state === "RUNNING";
    }

    function deletable(id) {
      var r = findReportById(id);
      return r && (r.state === "COMPLETED" || r.state === "ABORTED");
    }

    function downloadable(id) {
      var r = findReportById(id);
      return r && r.state === "COMPLETED";
    }

    function findReportById(id) {
      return _.find(vm.reports, function (report) {
        return report.id === id;
      });
    }

    vm.gridOptions = {
      data: 'ediscoveryCtrl.reports',
      multiSelect: false,
      rowHeight: 40,
      enableRowHeaderSelection: false,
      enableColumnResize: true,
      enableColumnMenus: false,
      enableHorizontalScrollbar: 0,

      columnDefs: [{
        field: 'displayName',
        displayName: 'Report Name',
        sortable: true
      }, {
        field: 'id',
        displayName: 'Id',
        sortable: false
      }, {
        field: 'createdTime',
        displayName: 'Date Generated',
        sortable: false,
      }, {
        field: 'createdByUserId',
        displayName: 'Generated By',
        sortable: false
      }, {
        field: 'state',
        displayName: 'State',
        sortable: false,
        cellTemplate: 'modules/ediscovery/cell-template-state.html'
      }, {
        field: 'failureReason',
        displayName: 'Reason',
        sortable: false,
      }, {
        field: 'sizeInBytes',
        displayName: 'Size (bytes)',
        sortable: false
      }, {
        field: 'actions',
        displayName: 'Actions',
        sortable: false,
        cellTemplate: 'modules/ediscovery/cell-template-action.html'
      }]
    };

    function randomString() {
      var possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
      return _.sample(possible, 5).join('');
    }

    function createReport() {
      if (!validateDate()) {
        return;
      }
      EdiscoveryService.createReport("whatever_" + randomString()).then(function (res) {
        pollAvalonReport();
      });
    }

    function deleteReports() {
      EdiscoveryService.deleteReports().then(function (res) {
        pollAvalonReport();
      });
    }

    function pollAvalonReport() {
      EdiscoveryService.getReport().then(function (res) {
        vm.reports = res;
        notifyOnEvent(vm.reports);
      }).finally(function (res) {
        $timeout.cancel(avalonPoller);
        avalonPoller = $timeout(pollAvalonReport, 5000);
      });
    }

    function setSearchFieldFocus() {
      angular.element('#searchInput').focus();
    }

    function showSearchHelp() {
      var searchHelpUrl = "modules/ediscovery/search-help-dialog.html";
      $modal.open({
        templateUrl: searchHelpUrl
      }).result.finally(function () {
        setSearchFieldFocus();
      });
    }

    funnction grantNotification() {
      if ($window.Notification) {
        $window.Notification.requestPermission().then(function (result) {});
      }
    }

    function notifyOnEvent(reports) {
      if (!$window.Notification || $window.Notification.permission != 'granted') {
        return;
      }
      var completedReports = _.filter(reports, function (r) {
        return r.state == 'COMPLETED';
      });
      if (completedReports && completedReports.length > 0) {
        var options = {
          body: 'You have ' + completedReports.length + ' completed reports',
          icon: 'images/cisco_logo.png',
          tag: 'ediscovery'
        };
        var n = new $window.Notification('eDiscovery Dashboard', options);
        setTimeout(n.close.bind(n), 3000);
      }
    }
  }

  function EdiscoveryGenericModalCtrl($modalInstance, title, messages) {
    var vm = this;
    vm.messages = $.isArray(messages) ? messages : [messages];
    vm.title = title;
  }

  angular
    .module('Ediscovery')
    .controller('EdiscoveryController', EdiscoveryController)
    .controller('EdiscoveryGenericModalCtrl', EdiscoveryGenericModalCtrl);
}());
