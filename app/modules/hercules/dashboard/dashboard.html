<div id="fusion-root">
  <div class="notification"></div>
  <div class="page-header row">
    <div>
      <h2 class="page-title">
        <span translate="hercules.page_title" />
        <div style="float: right">
          <button ng-disabled="inflight" class="btn btn-info" ng-click="reload()" style="position: fixed; z-index: 10; right: 10px;">
            <span ng-hide="inflight">
              <i class="icon icon-refresh" />
            </span>
            <span ng-show="inflight">
              <i class="icon icon-spinner icon-spin" />
            </span>
          </button>
        </div>
      </h2>
    </div>
  </div>
  <div>
    <div class="col-md-12">
      <div ng-show="loading" style="text-align: center; padding-top: 60px;">
        <i class="icon icon-spinner icon-2x"></i>
      </div>
      <div ng-show="!loading">
        <div ng-show="clusters.length == 0" class="col-md-12" style="padding: 20px 40px">
          <hercules-nothing-fused />
        </div>

        <div ng-show="clusters.length != 0">
          <hercules-dashboard-header/>
        </div>

        <div ng-show="clusters.length != 0" class="col-md-12">

          <accordion close-others="{{false}}">
            <accordion-group ng-repeat="cluster in clusters" is-open="cluster.initially_open">
              <accordion-heading>
                <h4>
                  <span class="{{cluster.needs_attention ? 'red' : cluster.running_hosts ? 'green' : ''}}" style="padding-right: 10px;">
                    <i class="fa fa-circle-o" />
                  </span>

                  <span>{{cluster.name || 'Unknown Cluster Name'}}</span>

                  <span ng-show="{{!cluster.needs_attention && cluster.provisioning_data.not_approved_packages.length}}" style="float: right; color: #00B29D;">
                    <span class="hidden-xs">Software Upgrades Available</span>
                    <span class="visible-xs"><i class="fa fa-cloud-download"></i></span>
                  </span>

                  <span ng-show="{{cluster.needs_attention}}"  style="float: right; color: #f05d3b;">
                    <span class="hidden-xs">Cluster Needs Attention</span>
                    <span class="visible-xs"><i class="fa fa-exclamation-circle"></i></span>
                  </span>
                </h4>
              </accordion-heading>

              <div class="connector-body">

                <!-- host list -->
                <div class="md-col-12 clearfix" style="padding-left: 15px;">
                  <span style="font-size: xs; opacity: 0.5">
                    <span>This cluster consists of {{cluster.hosts.length}} {{cluster.hosts.length == 1 ? 'host' : 'hosts'}}:</span>
                    <span ng-repeat="host in cluster.hosts">
                      <a href="https://{{host.host_name}}" target="_blank">
                        {{host.host_name}}
                      </a>
                      <span ng-hide="$last">|</span>
                    </span>
                  </span>

                  <div style="padding-top: 5px" class="clearfix" ng-repeat="host in cluster.hosts | filter: { offline: true }">
                    <span style="color: #f05d3b">{{host.host_name}}</span>
                    <span translate="{{'hercules.status.offline'}}" />
                  </div>

                </div>

                <!-- services -->
                <div class="sw-upgrade">
                  <div ng-repeat="service in cluster.services">
                    <div class="col-md-12 clearfix" ng-show="!service.needs_attention || (service.needs_attention && service.running_hosts)">
                      <h4 class="header pull-left">
                        <span class="clearfix" ng-show="{{service.needs_attention && service.running_hosts}}">
                          {{service.display_name}} needs attention:
                        </span>
                        <span ng-show="{{!service.needs_attention}}">
                          <span class="clearfix" ng-show="{{!service.is_disabled}}">
                            {{service.display_name}} is running on {{service.running_hosts}} {{service.running_hosts == 1 ? 'host' : 'hosts'}}
                          </span>
                          <span class="clearfix" ng-show="{{service.is_disabled}}" style="opacity: 0.5">
                            {{service.display_name}} is disabled
                          </span>
                        </span>
                      </h4>

                      <hercules-upgrade-button
                        cluster-id="{{cluster.id}}"
                        service-type="{{service.service_type}}"
                        class="hidden-xs pull-right"
                        ng-show="service.not_approved_package"
                      />

                    </div>
                    <div class="col-md-12" ng-show="{{service.needs_attention && service.running_hosts}}">

                      <!-- connectors -->
                      <div class="connector-info-item" ng-repeat="connector in service.connectors">
                        <!-- connector status -->
                        <div style="padding-bottom: 5px" class="clearfix" ng-show="{{connector.state != 'running' && connector.state != 'disabled' && connector.state != 'offline'}}">
                          <span style="color: #f05d3b">{{connector.host.host_name}}</span>
                          <span translate="{{'hercules.status.' + (connector.state || 'unknown') }}" />
                        </div>

                        <!-- connector deduced error -->
                        <div style="padding-bottom: 5px" class="clearfix" ng-repeat="alarm in connector.deduced_alarms">
                          <span style="color: #f05d3b">{{connector.host.host_name}}</span>
                          <span>is not running the correct software version. Should be {{alarm.expected_version}} but was {{connector.version}}.</span>
                        </div>

                        <!-- connector alarms -->
                        <div hercules-popover style="padding-bottom: 5px" class="clearfix" ng-show="{{connector.alarms.length}}">
                          <span style="color: #f05d3b">{{connector.host.host_name}}</span>
                          <span>has reported</span>
                          <a href="#" onclick="return false" class="popover-trigger">{{connector.alarms.length}} alarms.</a>
                          <div class="popover-title hide">
                            <i class="fa fa-exclamation-triangle" style="color: #f05d3b"></i> {{service.display_name}} Alarms
                          </div>
                          <div class="popover-content hide">
                            <div ng-repeat="alarm in connector.alarms">
                              <span style="color: #f05d3b">{{alarm.title}} ({{alarm.severity}})</span>
                              <p>{{alarm.description}}</p>
                            </div>
                            <p>
                              Go to the <a href="https://{{connector.host.host_name}}/alarms" target="_blank">Expressway alarms page</a>.
                            </p>
                          </div>
                        </div>
                      </div>

                      <!-- sw upgrade -->
                      <div class="connector-info-item" ng-show="service.not_approved_package">
                        <div style="padding-bottom: 5px" class="clearfix">
                          <span>A software update is avalable.</span>
                          <span ng-show="service.connectors[0].version">Current version: {{service.connectors[0].version}}.</span>
                          <span ng-show="service.not_approved_package.version">New version: {{service.not_approved_package.version}}.</span>
                        </div>
                        <hercules-upgrade-button
                          cluster-id="{{cluster.id}}"
                          service-type="{{service.service_type}}"
                          class="hidden-sm hidden-md hidden-lg"
                          ng-show="service.not_approved_package"
                        />
                      </div>

                    </div>
                  </div>
                </div>

              </div>

            </accordion-group>
          </accordion>

        </div>
      </div>
    </div>
  </div>
</div>
