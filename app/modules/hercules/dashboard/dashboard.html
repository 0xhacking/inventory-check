<div id="fusion-root">
  <div class="notification"></div>
  <div class="page-header row">
    <div>
      <h2 class="page-title">
        <span translate="hercules.page_title" />
        <div style="float: right; white-space: nowrap">
          <button class="btn btn-info" ng-click="showUCConfigDialog()" ng-show="fusionUCEnabled">
            <span>
              <i class="fa fa-wrench" />
            </span>
          </button>

          <button class="btn btn-info" ng-click="showNotificationConfigDialog()">
            <span>
              <i class="fa fa-bell" />
            </span>
          </button>

          <button ng-show="pollHasFailed" ng-disabled="inflight" class="btn btn-info" ng-click="reload()" style="transition: all 0 ease 0;">
            <span ng-hide="inflight">
              <i class="icon icon-refresh" />
            </span>
            <span ng-show="inflight">
              <i class="icon icon-refresh icon-spin" />
            </span>
          </button>
        </div>
      </h2>
    </div>
  </div>
  <div>
    <div class="col-md-12">
      <div ng-show="loading" style="text-align: center; padding-top: 60px;">
        <i class="icon icon-spinner icon-2x"></i>
      </div>
      <div ng-show="!loading">
        <div ng-show="clusters.length == 0" class="col-md-12" style="padding: 20px 40px">
          <hercules-nothing-fused />
        </div>

        <div ng-show="clusters.length != 0">
          <hercules-dashboard-header/>
        </div>

        <div ng-show="clusters.length != 0" class="col-md-12">

          <accordion close-others="{{false}}">
            <accordion-group ng-repeat="cluster in clusters" is-open="panelStates[cluster.id]">
              <accordion-heading>
                <h4 style="color: black">
                  <span class="{{cluster.needs_attention ? 'red' : cluster.running_hosts ? 'green' : ''}}" style="padding-right: 10px;">
                    <i class="fa fa-circle-o" />
                  </span>

                  <span>{{cluster.name || 'Unknown Cluster Name'}}</span>

                  <span ng-show="{{!cluster.needs_attention && cluster.software_upgrade_available}}" style="float: right; color: #00B29D;">
                    <span class="hidden-xs">Software Upgrades Available</span>
                    <span class="visible-xs"><i class="fa fa-cloud-download"></i></span>
                  </span>

                  <span ng-show="{{cluster.needs_attention}}"  style="float: right; color: #f05d3b;">
                    <span class="hidden-xs">Cluster Needs Attention</span>
                    <span class="visible-xs"><i class="fa fa-exclamation-circle"></i></span>
                  </span>
                </h4>
              </accordion-heading>

              <div class="connector-body">

                <!-- host list -->
                <div class="md-col-12 clearfix" style="padding-left: 15px;">
                  <span style="font-size: xs; opacity: 0.5">
                    <span>This cluster consists of {{cluster.hosts.length}} {{cluster.hosts.length == 1 ? 'host' : 'hosts'}}:</span>
                    <span ng-repeat="host in cluster.hosts">
                      <a href="https://{{host.host_name}}" target="_blank">
                        {{host.host_name}}
                      </a>
                      <span ng-hide="$last">|</span>
                    </span>
                  </span>

                  <div style="padding-top: 5px" class="clearfix connector-info-item" ng-repeat="host in cluster.hosts | filter: { offline: true }">
                    <span style="color: #f05d3b">{{host.host_name}}</span>
                    <span translate="{{'hercules.status.offline'}}" />
                    <a href>
                      <i class="icon icon-close" ng-click="toggleEdit(host.host_name)" />
                    </a>
                    <div style="margin-top: 5px" ng-show="host.host_name == editingHost">
                      <button ng-disabled="deleteHostInflight" class="btn btn-danger btn-sm" ng-click="deleteHost(cluster.id, host.serial)">
                        <span ng-hide="deleteHostInflight">
                          Delete {{host.host_name}}?
                        </span>
                        <span ng-show="deleteHostInflight">
                          <i class="icon icon-spinner icon-spin" />
                        </span>
                      </button>
                    </div>
                  </div>

                </div>

                <!-- services -->
                <div class="sw-upgrade">
                  <div ng-repeat="service in cluster.services">
                    <div class="col-md-12 clearfix">
                      <h4 class="header pull-left">
                        <span class="clearfix" ng-show="{{service.needs_attention && service.running_hosts}}">
                          {{service.display_name}} needs attention
                        </span>
                        <span class="clearfix" ng-show="{{service.needs_attention && !service.running_hosts}}">
                          {{service.display_name}} is not running
                        </span>
                        <span ng-show="{{!service.needs_attention}}">
                          <span class="clearfix" ng-show="{{!service.is_disabled && service.installed}}">
                            {{service.display_name}} is running on {{service.running_hosts}} {{service.running_hosts == 1 ? 'host' : 'hosts'}}
                          </span>
                          <span class="clearfix" ng-show="{{!service.is_disabled && !service.installed && !service.install_available}}">
                            {{service.display_name}} is pending installation
                          </span>
                          <span class="clearfix" ng-show="{{!service.is_disabled && !service.installed && service.install_available}}">
                            {{service.display_name}} is not installed
                          </span>
                          <span class="clearfix" ng-show="{{service.is_disabled}}" style="opacity: 0.5">
                            {{service.display_name}} is disabled
                          </span>
                        </span>
                      </h4>
                    </div>

                    <div class="col-md-12">

                      <!-- connectors -->
                      <div class="connector-info-item" ng-repeat="connector in service.connectors">
                        <!-- connector status -->
                        <div style="padding-bottom: 5px" class="clearfix" ng-show="{{connector.state != 'running' && connector.state != 'disabled' && connector.state != 'offline'}}">
                          <span style="color: #f05d3b">{{connector.host.host_name}}</span>
                          <span translate="{{'hercules.status.' + (connector.state || 'unknown') }}" />
                        </div>

                        <!-- connector deduced error -->
                        <div style="padding-bottom: 5px" class="clearfix" ng-repeat="alarm in connector.deduced_alarms">
                          <span style="color: #f05d3b">{{connector.host.host_name}}</span>
                          <span>is pending software upgrade from {{connector.version}} to {{alarm.expected_version}}.</span>
                        </div>

                        <!-- connector alarms -->
                        <div ng-show="{{connector.alarms.length}}">
                          <div class="clearfix" style="padding-bottom: 5px">
                            <span style="color: #f05d3b">{{connector.host.host_name}}</span>
                            <span ng-show="connector.alarms.length == 1">has reported {{connector.alarms.length}} alarm</span>
                            <span ng-hide="connector.alarms.length == 1">has reported {{connector.alarms.length}} alarms</span>
                            <a href ng-click="toggleAlarms(cluster.id, service.service_type, connector.host.host_name)">
                              <span ng-show="visibleAlarm.clusterId == cluster.id && visibleAlarm.serviceType == service.service_type && visibleAlarm.hostName == connector.host.host_name">
                                <i class="icon icon-chevron-up" />
                              </span>
                              <span ng-hide="visibleAlarm.clusterId == cluster.id && visibleAlarm.serviceType == service.service_type">
                                <i class="icon icon-chevron-down" />
                              </span>
                            </a>
                          </div>

                          <div style="padding-left: 20px"  ng-show="visibleAlarm.clusterId == cluster.id && visibleAlarm.serviceType == service.service_type && visibleAlarm.hostName == connector.host.host_name">
                            <div ng-repeat="alarm in connector.alarms" style="padding-bottom: 5px;" class="clearfix">
                              <span style="color: #f05d3b; text-transform: capitalize;">{{alarm.severity}}:</span>
                              <span>{{alarm.title}}.</span>
                              <span>{{alarm.description}}</span>
                            </div>
                            <div style="padding-bottom: 5px">
                              Manage the alarms in the <a href="https://{{connector.host.host_name}}/alarms" target="_blank">alarms page</a>.
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- sw upgrade -->
                      <div class="connector-info-item" ng-show="service.software_upgrade_available">
                        <div ng-show="service.installed">
                          <!-- sw update for existing service -->
                            <div style="padding-bottom: 5px" class="clearfix">
                              <span>A software update is available.</span>
                              <span ng-show="service.connectors[0].version">Current version: {{service.connectors[0].version}}.</span>
                              <span ng-show="service.not_approved_package.version">New version: {{service.not_approved_package.version}}.</span>
                            </div>
                            <div style="padding-bottom: 5px">
                              <hercules-upgrade-button
                                cluster-id="{{cluster.id}}"
                                service-type="{{service.service_type}}",
                                button-text="Upgrade Now"
                                />
                            </div>
                        </div>

                        <div ng-show="!service.installed && service.install_available">
                          <!-- install the new service -->
                          <div style="padding-bottom: 5px">
                            <hercules-upgrade-button
                              cluster-id="{{cluster.id}}"
                              service-type="{{service.service_type}}",
                              button-text="Install Now"
                              />
                          </div>
                        </div>

                      </div>

                    </div>
                  </div>
                </div>

              </div>

            </accordion-group>
          </accordion>

        </div>
      </div>
    </div>
  </div>
</div>
